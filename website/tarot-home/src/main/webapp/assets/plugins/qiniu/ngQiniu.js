"use strict";(function(){var a=angular.module("ngQiniu",[]);a.service("$qupload",["$http","$q",function(i,e){function g(m){var k,l,j,n;k="";j=m.length;for(l=0;l<j;l++){n=m.charCodeAt(l);if((n>=1)&&(n<=127)){k+=m.charAt(l)}else{if(n>2047){k+=String.fromCharCode(224|((n>>12)&15));k+=String.fromCharCode(128|((n>>6)&63));k+=String.fromCharCode(128|((n>>0)&63))}else{k+=String.fromCharCode(192|((n>>6)&31));k+=String.fromCharCode(128|((n>>0)&63))}}}return k}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";function f(p){var l,n,j;var o,m,k;j=p.length;n=0;l="";while(n<j){o=p.charCodeAt(n++)&255;if(n==j){l+=c.charAt(o>>2);l+=c.charAt((o&3)<<4);l+="==";break}m=p.charCodeAt(n++);if(n==j){l+=c.charAt(o>>2);l+=c.charAt(((o&3)<<4)|((m&240)>>4));l+=c.charAt((m&15)<<2);l+="=";break}k=p.charCodeAt(n++);l+=c.charAt(o>>2);l+=c.charAt(((o&3)<<4)|((m&240)>>4));l+=c.charAt(((m&15)<<2)|((k&192)>>6));l+=c.charAt(k&63)}return l}var b="http://up.qiniu.com";if(window&&window.location&&window.location.protocol==="https:"){b="https://up.qbox.me"}var d={chunkSize:1024*1024*4,mkblkEndPoint:b+"/mkblk/",mkfileEndPoint:b+"/mkfile/",maxRetryTimes:3};this.support=(typeof File!=="undefined"&&typeof Blob!=="undefined"&&typeof FileList!=="undefined"&&(!!Blob.prototype.slice||!!Blob.prototype.webkitSlice||!!Blob.prototype.mozSlice||false));if(!this.support){return null}var h=function(j){return j.name+j.lastModified+j.size+j.type};this.upload=function(m){var t=e.defer();var u=t.promise;var o=m.file;if(!o){return}var r=h(o);var k=null;if(!k){k=[]}var j=(o.size+((1<<22)-1))>>22;var n=function(v,x,w){return v[(v.slice?"slice":(v.mozSlice?"mozSlice":(v.webkitSlice?"webkitSlice":"slice")))](x,w)};var l=function(v,x,w){if(w===x-1){return v.size-4194304*w}else{return 4194304}};var p=function(A,x){if(x.length===0){return}var w="";var v;for(var z=0;z<x.length-1;z++){v=angular.fromJson(x[z]);w+=(v.ctx+",")}v=angular.fromJson(x[x.length-1]);w+=v.ctx;var y=d.mkfileEndPoint+A.size;if(m&&m.key){y+=("/key/"+f(g(m.key)))}i({url:y,method:"POST",data:w,headers:{"Authorization":"UpToken "+m.token,"Content-Type":"text/plain"}}).success(function(B){t.resolve(B)}).error(function(B){t.reject(B)})};var s;var q=function(y,x,v){if(x===j){p(y,k);return}if(!v){t.reject("max retried,still failure");return}var A=l(y,j,x);var z=x*4194304;var w=n(y,z,z+A);s=new XMLHttpRequest();s.open("POST",d.mkblkEndPoint+A,true);s.setRequestHeader("Authorization","UpToken "+m.token);s.upload.addEventListener("progress",function(C){if(C.lengthComputable){var B={totalSize:y.size,loaded:C.loaded+z};t.notify(B)}});s.upload.onerror=function(){q(m.file,x,--v)};s.onreadystatechange=function(B){if(B&&s.readyState===4&&s.status===200){if(s.status===200){k[x]=s.responseText;q(m.file,++x,d.maxRetryTimes)}else{q(m.file,x,--v)}}};s.send(w)};q(m.file,k.length,d.maxRetryTimes);u.abort=function(){s.abort()};u.pause=function(){s.abort()};return u}}])})();